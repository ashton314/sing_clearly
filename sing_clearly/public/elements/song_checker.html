<!-- -*- mode: web -*- -->

<dom-module id="song-checker">
    <template>
	<link rel="stylesheet" href="/css/bootstrap.min.css">

	<div class="card-deck mb-3">
	    <div class="card col-md-4 col-12">
		<div class="card-body">
		    <h3>Add to Blacklist</h3>

		    <div class="form-group">
			<label for="bad-phrase">Bad Phrase:</label>
			<input type="text" class="form-control" value="{{blacklist_phrase::input}}">
		    </div>
		    <button class="btn btn-success" on-click="addBlacklist">Add Phrase</button>
		</div>
	    </div>
	    <div class="card col-md-8 col-12">
		<div class="card-body">
		    <h3>Song</h3>
		    
		    <div class="form-group">
			<label for="song-title">Title</label>
			<input type="text" class="form-control" value="{{song.title::input}}" placeholder="I won't give up" autofocus>
		    </div>
		    <div class="form-group">
			<label for="song-artist">Artist</label>
			<input type="text" class="form-control" value="{{song.artist::input}}" placeholder="Jason Mraz">
		    </div>
		    <button class="btn btn-primary" on-click="go">Check</button>
		</div>
	    </div>
	</div>

	<div class="card">
	    <div class="card-body">
		<h4 class="card-title">Score for [[score.title]] by [[score.artist]]</h4>
		<p>
		    Link to lyrics <a href$="[[score.link]]">here</a>.
		</p>
		<p>
		    Number of blacklisted phrases found: [[score.phrase_count]]
		</p>
		<p>
		    <button class="btn btn-outline-primary" type="button" on-click="togglePhraseListing">View phrases caught</button>
		    <div class="collapse" id="phrase-listing">
			<table class="table">
			    <thead>
				<tr><th>Phrase:</th></r>
			    </thead>
			    <tbody>
				<template is="dom-repeat" items="[[score.phrases]]" as="phrase">
				    <tr><td>[[phrase]]</td></tr>
				</template>
			    </tbody>
			</table>
		    </div>
		</p>
	    </div>
	</div>

    </template>
    <script>
     class SongChecker extends Polymer.Element {
	 addBlacklist() {
	     $.post('/blacklist', {phrase: this.blacklist_phrase},
		    ((success) => {
			this.set('blacklist_phrase', '');
			alert('added'); }).bind(this));
	 }
	 go() {
	     $.get('/check-song', this.song)
	      .done(((data) => {
		  this.set('score', data);
	      }).bind(this))
	      .fail((result) => {
		  alert("No songs found.");
	      });
	 }
	 togglePhraseListing() {
	     $(this.shadowRoot.querySelector('#phrase-listing')).collapse('toggle');
	 }

	 /* Boilerplate */
	 static get is() {
	     return 'song-checker';
	 }
	 static get properties() {
	     return {
		 song: {
		     type: Object,
		     value: { title: "",
			      artist: "" },
		     notify: true
		 },
		 score: {
		     type: Object,
		     value: { phrase_count: "",
			      phrases: [],
			      link: "#",
			      title: "",
			      artist: "" },
		     notify: true
		 },
	     };
	 }
	 constructor() {
	     super();
	     this.go = this.go.bind(this);
	     this.addBlacklist = this.addBlacklist.bind(this);
	     this.togglePhraseListing = this.togglePhraseListing.bind(this);
	 }
	 ready() {
	     super.ready();
	 }
     }
     customElements.define(SongChecker.is, SongChecker);
    </script>
</dom-module>
